```{r load-oms, message = FALSE}
knitr_results <- TRUE
knitr_echo <- TRUE
library(purrr)
sc <- readRDS(here::here("mse/om/ye-scenarios2.rds"))
oms <- sc$scenario %>% set_names() %>%
  map(~ readRDS(here::here(paste0("mse/om/", .x, ".rds")))@OM)
names(oms) <- sc$scenario_human
nsim <- oms[[1]]@nsim
```

```{r display-om}
display_om <- function(om, slot) {
  out <- NULL
  x <- purrr::map(om, slot)
  cpars <- purrr::map(om, ~.x@cpars[[slot]])
  if ((length(unique(x)) == 1L && is.null(unlist(cpars))) |
      (length(unique(cpars[[1]])) == 1L && !is.null(unlist(cpars)))) {
    out <- x[[1]]
  } else if ((length(unique(x)) > 1L && is.null(unlist(cpars)))) {
    out <- reshape2::melt(x) %>% 
      dplyr::mutate(type = rep(c("min", "max"), length(om)/2)) %>%
      tidyr::pivot_wider(names_from = type, values_from = value) %>%
      dplyr::rename(scenario = L1)
  }
  if (!is.null(unlist(cpars)) && length(unique(cpars[[1]])) > 1L) {
    dat <- reshape2::melt(cpars)
    out <- ggplot(dat, aes(value)) + 
      geom_histogram(position="identity", bins = 18, fill = "grey85", 
        colour = "grey50") + 
      facet_wrap(~L1, nrow = 2) +
      gfdlm::theme_pbs() + 
      coord_cartesian(expand = FALSE) + 
      xlab(slot) +
      ylab("Frequency")
  }
  out
}
```

# INSIDE YELLOWEYE ROCKFISH OPERATING MODEL DEFINITION {#app:desc-om-yelloweye}

## STOCK SLOT DESCRIPTIONS {#app:desc-stock-yelloweye}

<!-- slot-chunk-begin -->
### maxage {#app:desc-stock-maxage-yelloweye}

*The maximum age of individuals that is simulated. Positive integer.*

```{r desc-stock-maxage-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "maxage")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### M {#app:desc-stock-m-yelloweye}

*Natural mortality rate. Uniform distribution lower and upper bounds.*

Natural mortality and Beverton-Holt steepness are core uncertainties for many stocks.
We incorporated uncertainty using a Monte Carlo approach, by sampling them from prior distributions generated from meta-analysis:

TODO: M ~ Lognormal(0.045, 0.2) from Hoenig et al. (1983) using maxage = 101 years

We drew M stochastically from a Lognormal(0.045, 0.2) distribution with the seed in R set to 91283:

```{r, eval=FALSE, echo=TRUE}
set.seed(91283)
OM@cpars$M <- rlnorm(nsim, log(0.045) - 0.5 * 0.2^2, 0.2)
```

```{r desc-stock-m-yelloweye, results = knitr_results, echo = knitr_echo, fig.cap="M"}
display_om(oms, "M")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### h {#app:desc-stock-h-yelloweye}

*Steepness of the stock-recruit relationship. Uniform distribution lower and upper bounds with values from 1/5 to 1.*

TODO: tidy this
- h ~ Transformed Beta(mean = 0.71, sd = 0.15) using Forrest et al. prior
- For h, sample X ~ Beta(alpha, beta), then transform: h = 0.8 X + 0.2. Alpha and beta are values so that mean(h) = 0.71, sd(h) = 0.15

TODO: Not sure where the 0.6375 and 0.12 come from --- whether that's just from experimentation or some analytical solution rounded. It doesn't seem to work out to 0.15... that's fine but we should note it.

TODO: see next temporary chunk; this isn't SD = 0.15 (should be h_alpha <- alphaconv(0.6375, 0.15/0.8)) etc.

TODO: Quang: Even with SD = 0.12, there were some very low values of steepness which generated FMSY < 0.01 I believe, so the smaller SD made it easier to avoid those outliers

TODO: Quang: Even the current histogram shows h samples between 0.5 - 0.9 which should be sufficient coverage

```{r, eval=FALSE, echo=FALSE}
alphaconv <- function (m, sd) {
  m * (((m * (1 - m))/(sd^2)) - 1)
}
betaconv <- function (m, sd) {
  (1 - m) * (((m * (1 - m))/(sd^2)) - 1)
}
h_alpha <- alphaconv((0.71 - 0.2) / 0.8, 0.12)
h_beta <- betaconv((0.71 - 0.2) / 0.8, 0.12)
h_samps <- rbeta(1e6, h_alpha, h_beta)
h_samps <- 0.8 * h_samps + 0.2
mean(h_samps)
sd(h_samps)
```

TODO: ... with the seed in R set to 65423:

```{r, eval=TRUE, echo=TRUE}
alphaconv <- function(m, sd) {
  m * (((m * (1 - m)) / (sd^2)) - 1)
}
betaconv <- function(m, sd) {
  (1 - m) * (((m * (1 - m)) / (sd^2)) - 1)
}
h_alpha <- alphaconv((0.71 - 0.2), 0.12)
h_beta <- betaconv((0.71 - 0.2), 0.12)
set.seed(65423)
h_samps <- rbeta(nsim, h_alpha, h_beta)
h_samps <- 0.8 * h_samps + 0.2
mean(h_samps)
sd(h_samps)
```

```{r, eval=FALSE, echo=TRUE}
OM@cpars$h <- h_samps
```

```{r desc-stock-h-yelloweye, results = knitr_results, echo = knitr_echo, fig.cap="h"}
display_om(oms, "h")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### Perr {#app:desc-stock-perr-yelloweye}

*Process error, the CV of lognormal recruitment deviations. Uniform distribution lower and upper bounds.*

```{r desc-stock-perr-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "Perr")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### Linf {#app:desc-stock-linf-yelloweye}

*Maximum length. Uniform distribution lower and upper bounds.*

```{r desc-stock-linf-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "Linf")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### K {#app:desc-stock-k-yelloweye}

*von Bertalanffy growth parameter k. Uniform distribution lower and upper bounds.*

```{r desc-stock-k-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "K")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### t0 {#app:desc-stock-t0-yelloweye}

*von Bertalanffy theoretical age at length zero. Uniform distribution lower and upper bounds.*

```{r desc-stock-t0-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "t0")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### L50 {#app:desc-stock-l50-yelloweye}

*Length at 50% maturity. Uniform distribution lower and upper bounds.*

```{r desc-stock-l50-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "L50")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### L50_95 {#app:desc-stock-l50_95-yelloweye}

*Length increment from 50% to 95% maturity. Uniform distribution lower and upper bounds.*

```{r desc-stock-l50_95-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "L50_95")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### a {#app:desc-stock-a-yelloweye}

*Length-weight parameter alpha. Positive real number.*

```{r desc-stock-a-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "a")
exp(display_om(oms, "a"))
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### b {#app:desc-stock-b-yelloweye}

*Length-weight parameter beta. Positive real number.*

```{r desc-stock-b-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "b")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### Fdisc {#app:desc-stock-fdisc-yelloweye}

*Fraction of discarded fish that die. Uniform distribution lower and upper bounds.*

Not used, we assume all sources of mortality are included in catch.

```{r desc-stock-fdisc-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "Fdisc")
```
<!-- slot-chunk-end -->

## FLEET SLOT DESCRIPTIONS {#app:desc-fleet-yelloweye}

<!-- slot-chunk-begin -->
### nyears {#app:desc-fleet-nyears-yelloweye}

*The number of years for the historical spool-up simulation.*

```{r desc-fleet-nyears-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "nyears")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### L5 {#app:desc-fleet-l5-yelloweye}

*Shortest length corresponding to 5% vulnerability. Uniform distribution lower and upper bounds.*

Selectivity of recreational and commercial fleets are fixed in SRA_scope, which updates the OM.

TODO: give here and plot?

```{r desc-fleet-l5-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "L5")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### LFS {#app:desc-fleet-lfs-yelloweye}

*Shortest length that is fully vulnerable to fishing. Uniform distribution lower and upper bounds.*

TODO: give here and plot?

Selectivity of recreational and commercial fleets are fixed in SRA_scope, which updates the OM.

```{r desc-fleet-lfs-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "LFS")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### Vmaxlen {#app:desc-fleet-vmaxlen-yelloweye}

*The vulnerability of fish at `Linf`. Uniform distribution lower and upper bounds. Fraction.*

Selectivity of recreational and commercial fleets are fixed in SRA_scope, which updates the OM.

```{r desc-fleet-vmaxlen-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "Vmaxlen")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### LR5 {#app:desc-fleet-lr5-yelloweye}

*Shortest length corresponding ot 5% retention. Uniform distribution lower and upper bounds.*

Because we model all discards as part of the catch this parameter will have no effect and so is not set.

```{r desc-fleet-lr5-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "LR5")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### LFR {#app:desc-fleet-lfr-yelloweye}

*Shortest length that is fully retained. Uniform distribution lower and upper bounds.*

No discard dynamics are modeled. We assume all mortality is accounted for in catch.

```{r desc-fleet-lfr-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "LFR")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### Rmaxlen {#app:desc-fleet-rmaxlen-yelloweye}

*The retention of fish at `Linf`. Uniform distribution lower and upper bounds.*

```{r desc-fleet-rmaxlen-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "Rmaxlen")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### DR {#app:desc-fleet-dr-yelloweye}

*Discard rate: the fraction of caught fish that are discarded. Uniform distribution lower and upper bounds. Fraction.*

No discard dynamics are modeled. We assume all mortality is accounted for in catch.

```{r desc-fleet-dr-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "DR")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### CurrentYr {#app:desc-fleet-currentyr-yelloweye}

*The current calendar year (final year) of the historical simulations (e.g., 2019).*

```{r desc-fleet-currentyr-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "CurrentYr")
```
<!-- slot-chunk-end -->

## OBS SLOT DESCRIPTIONS {#app:desc-obs-yelloweye}

<!-- slot-chunk-begin -->
### Cobs {#app:desc-obs-cobs-yelloweye}

*Log-normal catch obs observation error expressed as a CV. Uniform distribution lower and upper bounds.*

```{r desc-obs-cobs-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "Cobs")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### Cbiascv {#app:desc-obs-cbiascv-yelloweye}

*Log-normal CV controlling the sampling of bias in catch observations for each simulation. Uniform distribution lower and upper bounds.*

```{r desc-obs-cbiascv-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "Cbiascv")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### Iobs {#app:desc-obs-iobs-yelloweye}

*Observation error in the relative abundance indices expressed as a SD. Uniform distribution lower and upper bounds.*

This was set to 0.25, based on the SD of the observed HBLL index, except for the robustness scenario "(B) Higher HBLL CV" where this was set to the SD and autocorrelation from the index residuals in OM (1) for future projections of the HBLL index (see Section \@ref(sec:approach3-referenceB)).
We can not display this parameter here because it is added in the code as `AddIerr` in the "additional index" functionality of DLMtool.

```{r desc-obs-iobs-yelloweye, results = knitr_results, echo = knitr_echo, eval=FALSE}
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### beta {#app:desc-obs-beta-yelloweye}

*A parameter controlling hyperstability/hyperdepletion where values below 1 lead to hyperstability (an index that decreases more slowly than true abundance) and values above 1 lead to hyperdepletion (an index that decreases more rapidly than true abundance). Uniform distribution lower and upper bounds.*

We set the hyperstability/hyperdepletion $\beta$ parameter to 1 to imply no hyperstability or hyperdepletion.
This gets set via the SRA model and so is not specified here.

```{r desc-obs-beta-yelloweye, results = knitr_results, echo = knitr_echo, eval=FALSE}
```
<!-- slot-chunk-end -->

## IMP SLOT DESCRIPTIONS {#app:desc-imp-yelloweye}

<!-- slot-chunk-begin -->
### TACFrac {#app:desc-imp-tacfrac-yelloweye}

*Mean fraction of TAC taken. Uniform distribution lower and upper bounds.*

```{r desc-imp-tacfrac-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "TACFrac")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### TACSD {#app:desc-imp-tacsd-yelloweye}

*Log-normal CV in the fraction of TAC taken. Uniform distribution lower and upper bounds.*

```{r desc-imp-tacsd-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "TACSD")
```
<!-- slot-chunk-end -->

