```{r load-oms, message = FALSE}
knitr_results <- TRUE
knitr_echo <- TRUE
library(purrr)
sc <- readRDS(here::here("mse/om/ye-scenarios2.rds"))
oms <- sc$scenario %>% set_names() %>%
  map(~ readRDS(here::here(paste0("mse/om/", .x, ".rds")))@OM)
names(oms) <- sc$scenario_human
nsim <- oms[[1]]@nsim
```

```{r display-om}
display_om <- function(om, slot) {
  out <- NULL
  x <- purrr::map(om, slot)
  cpars <- purrr::map(om, ~.x@cpars[[slot]])
  if ((length(unique(x)) == 1L && is.null(unlist(cpars))) |
      (length(unique(cpars[[1]])) == 1L && !is.null(unlist(cpars)))) {
    out <- x[[1]]
  } else if ((length(unique(x)) > 1L && is.null(unlist(cpars)))) {
    out <- reshape2::melt(x) %>% 
      dplyr::mutate(type = rep(c("min", "max"), length(om)/2)) %>%
      tidyr::pivot_wider(names_from = type, values_from = value) %>%
      dplyr::rename(scenario = L1)
  }
  if (!is.null(unlist(cpars)) && length(unique(cpars[[1]])) > 1L) {
    dat <- reshape2::melt(cpars)
    out <- ggplot(dat, aes(value)) + 
      geom_histogram(position="identity", bins = 18, fill = "grey85", 
        colour = "grey50") + 
      facet_wrap(~L1, nrow = 2) +
      gfdlm::theme_pbs() + 
      coord_cartesian(expand = FALSE) + 
      xlab(slot) +
      ylab("Frequency")
  }
  out
}
```

# INSIDE YELLOWEYE ROCKFISH OPERATING MODEL DEFINITION {#app:desc-om-yelloweye}

## STOCK SLOT DESCRIPTIONS {#app:desc-stock-yelloweye}

<!-- slot-chunk-begin -->
### maxage {#app:desc-stock-maxage-yelloweye}

*The maximum age of individuals that is simulated. Positive integer.*

```{r desc-stock-maxage-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "maxage")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### M {#app:desc-stock-m-yelloweye}

*Natural mortality rate.*

Natural mortality is a core uncertainty for most stocks. We incorporated uncertainty using a Monte Carlo approach, by sampling M from prior distributions generated from meta-analysis:

TODO: M ~ Lognormal(0.045, 0.2) from Hoenig et al. (1983) using maxage = 101 years. Also cite Yamanaka et al. (2011) for the standard deviation of 0.2.

We drew M stochastically from a Lognormal(0.045, 0.2) distribution with the seed in R set to 91283:

```{r, eval=FALSE, echo=TRUE}
set.seed(91283)
OM@cpars$M <- rlnorm(nsim, log(0.045) - 0.5 * 0.2^2, 0.2)
```

```{r desc-stock-m-yelloweye, results = knitr_results, echo = knitr_echo, fig.cap="M"}
display_om(oms, "M")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### h {#app:desc-stock-h-yelloweye}

*Steepness of the stock-recruit relationship.*

Steepness is another core uncertainty for most stocks. We incorporated uncertainty using a Monte Carlo approach, by sampling h from prior distributions generated from meta-analysis:

TODO: tidy this
- h ~ Transformed Beta(mean = 0.71, sd = 0.15) using Forrest et al. prior
- For h, sample X ~ Beta(alpha, beta), then transform: h = 0.8 X + 0.2. Alpha and beta are values so that mean(h) = 0.71, sd(h) = 0.15

TODO: Not sure where the 0.6375 and 0.12 come from --- whether that's just from experimentation or some analytical solution rounded. It doesn't seem to work out to 0.15... that's fine but we should note it.

TODO: see next temporary chunk; this isn't SD = 0.15 (should be h_alpha <- alphaconv(0.6375, 0.15/0.8)) etc.

TODO: Quang: Even with SD = 0.12, there were some very low values of steepness which generated FMSY < 0.01 I believe, so the smaller SD made it easier to avoid those outliers

TODO: Quang: Even the current histogram shows h samples between 0.5 - 0.9 which should be sufficient coverage

```{r, eval=FALSE, echo=FALSE}
alphaconv <- function (m, sd) {
  m * (((m * (1 - m))/(sd^2)) - 1)
}
betaconv <- function (m, sd) {
  (1 - m) * (((m * (1 - m))/(sd^2)) - 1)
}
h_alpha <- alphaconv((0.71 - 0.2) / 0.8, 0.12)
h_beta <- betaconv((0.71 - 0.2) / 0.8, 0.12)
h_samps <- rbeta(1e6, h_alpha, h_beta)
h_samps <- 0.8 * h_samps + 0.2
mean(h_samps)
sd(h_samps)
```

TODO: ... with the seed in R set to 65423:

```{r, eval=TRUE, echo=TRUE}
alphaconv <- function(m, sd) {
  m * (((m * (1 - m)) / (sd^2)) - 1)
}
betaconv <- function(m, sd) {
  (1 - m) * (((m * (1 - m)) / (sd^2)) - 1)
}
h_alpha <- alphaconv((0.71 - 0.2), 0.12)
h_beta <- betaconv((0.71 - 0.2), 0.12)
set.seed(65423)
h_samps <- rbeta(nsim, h_alpha, h_beta)
h_samps <- 0.8 * h_samps + 0.2
mean(h_samps)
sd(h_samps)
```

```{r, eval=FALSE, echo=TRUE}
OM@cpars$h <- h_samps
```

```{r desc-stock-h-yelloweye, results = knitr_results, echo = knitr_echo, fig.cap="h"}
display_om(oms, "h")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### Perr {#app:desc-stock-perr-yelloweye}

*Process error, the CV of lognormal recruitment deviations.*

A value of 0.4 was used as estimated in @cox2020 for the outside population.
```{r desc-stock-perr-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "Perr")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### Linf {#app:desc-stock-linf-yelloweye}

*Mean asymptotic length.*

This value was estimated from Appendix \@ref(app:biological-data). No sexual dimorphism was observed, so this parameter was estimated for both males and females combined.

```{r desc-stock-linf-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "Linf")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### K {#app:desc-stock-k-yelloweye}

*von Bertalanffy growth parameter k.*

This value was estimated from Appendix \@ref(app:biological-data). No sexual dimorphism was observed, so this parameter was estimated for both males and females combined.

```{r desc-stock-k-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "K")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### t0 {#app:desc-stock-t0-yelloweye}

*von Bertalanffy theoretical age at length zero.*

This value was estimated from Appendix \@ref(app:biological-data). No sexual dimorphism was observed, so this parameter was estimated for both males and females combined.

```{r desc-stock-t0-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "t0")
```
<!-- slot-chunk-end -->


<!-- slot-chunk-begin -->
### Maturity {#app:desc-stock-maturity-yelloweye}

*Maturity ogive.*

Maturity was directly overwritten as an age-based function. Female maturity at age was estimated from Appendix \@ref(app:biological-data) an used here. The minimum age observed to be mature was 7 years and it assumed that younger ages were all immature.

```{r desc-stock-maturity, eval = FALSE, echo = TRUE}
create_maturity_ogive <- function(A50, A95, maxage, Amin) {
  ages <- 1:maxage
  mat_age <- 1/(1 + exp(log(19) * (ages - A50)/(A95 - A50)))
  return(ifelse(ages < Amin, 0, Amin, mat_age))
}
OM@cpars$Mat_age <- create_maturity_ogive(14.4, 27.4, OM@maxage, 7) %>% 
  array(OM@maxage, OM@nyears + OM@proyears, OM@nsim) %>% aperm(c(3, 1, 2))
```

<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### L50 {#app:desc-stock-l50-yelloweye}

*Length at 50% maturity.*

Not used since maturity was directly input as an age-based function. See description of \@ref(app:desc-stock-maturity-yelloweye).

```{r desc-stock-l50-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "L50")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### L50_95 {#app:desc-stock-l50_95-yelloweye}

*Length increment from 50% to 95% maturity.*

Not used since maturity was directly input as an age-based function. See description of \@ref(app:desc-stock-maturity-yelloweye).

```{r desc-stock-l50_95-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "L50_95")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### a {#app:desc-stock-a-yelloweye}

*Length-weight parameter alpha. Positive real number.*

This value was estimated from Appendix \@ref(app:biological-data). No sexual dimorphism was observed, so this parameter was estimated for both males and females combined.
```{r desc-stock-a-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "a")
exp(display_om(oms, "a"))
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### b {#app:desc-stock-b-yelloweye}

*Length-weight parameter beta. Positive real number.*

This value was estimated from Appendix \@ref(app:biological-data). No sexual dimorphism was observed, so this parameter was estimated for both males and females combined.

```{r desc-stock-b-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "b")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### Fdisc {#app:desc-stock-fdisc-yelloweye}

*Fraction of discarded fish that die. Uniform distribution lower and upper bounds.*

Not used, we assume all sources of mortality are included in catch.

```{r desc-stock-fdisc-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "Fdisc")
```
<!-- slot-chunk-end -->

## FLEET SLOT DESCRIPTIONS {#app:desc-fleet-yelloweye}

<!-- slot-chunk-begin -->
### nyears {#app:desc-fleet-nyears-yelloweye}

*The number of years for the historical spool-up simulation.*

The time series of catch (1918-2019) was used to encapsulate the historical period of the operating model.
 
```{r desc-fleet-nyears-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "nyears")
```
<!-- slot-chunk-end -->


<!-- slot-chunk-begin -->
### Selectivity {#app:desc-fleet-selectivity-yelloweye}

*Shortest length corresponding to 5% vulnerability. Uniform distribution lower and upper bounds.*

Selectivity of the recreational and commercial fleets was obtained from @cox2020 and fixed in the SRA model, which updates the OM. Selectivity was parameterized as a logistic function by age. For the recreational fleet, the age of 50% and 95% selectivity was 6.7 and 11.5 years, respectively. For the commercial fleet, primarily hook-and-line, the age of 50% and 95% selectivity was 14.4 and 21 years, respectively.


(ref:fig-sel-fleet) Selectivity used for the recreational and commercial fleets.

```{r sra-selectivity, fig.cap="(ref:fig-sel-fleet)", out.width="3.8in"}
knitr::include_graphics(here::here("mse/figures/fishery-selectivity2.png"))
```

The SRA estimates fishing mortality by age and year. Annually the selectivity in the historical period is obtained by dividing the annual F at age by the apical F. During the projection period, the selectivity is equal to that in the last historical year.

(ref:fig-om-sel) Terminal year selectivity for the operating models.

```{r om-selectivity, fig.cap="(ref:fig-om-sel)", out.width="4.5in"}
knitr::include_graphics(here::here("mse/figures/fishery-selectivity-terminal-year.png"))
```

<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### L5 {#app:desc-fleet-l5-yelloweye}

*Shortest length corresponding to 5% vulnerability.*

Not used since selectivity is updated by the SRA. See description of \@ref(app:desc-fleet-selectivity-yelloweye).

```{r desc-fleet-l5-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "L5")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### LFS {#app:desc-fleet-lfs-yelloweye}

*Shortest length that is fully vulnerable to fishing.*

Not used since selectivity is updated by the SRA. See description of \@ref(app:desc-fleet-selectivity-yelloweye).

```{r desc-fleet-lfs-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "LFS")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### Vmaxlen {#app:desc-fleet-vmaxlen-yelloweye}

*The vulnerability of fish at `Linf`.*

Not used since selectivity is updated by the SRA. See description of \@ref(app:desc-fleet-selectivity-yelloweye).

```{r desc-fleet-vmaxlen-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "Vmaxlen")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### LR5 {#app:desc-fleet-lr5-yelloweye}

*Shortest length corresponding ot 5% retention. Uniform distribution lower and upper bounds.*

Because we model all discards as part of the catch this parameter will have no effect and so is not set.

```{r desc-fleet-lr5-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "LR5")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### LFR {#app:desc-fleet-lfr-yelloweye}

*Shortest length that is fully retained. Uniform distribution lower and upper bounds.*

No discard dynamics are modeled. We assume all mortality is accounted for in catch.

```{r desc-fleet-lfr-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "LFR")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### Rmaxlen {#app:desc-fleet-rmaxlen-yelloweye}

*The retention of fish at `Linf`. Uniform distribution lower and upper bounds.*

```{r desc-fleet-rmaxlen-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "Rmaxlen")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### DR {#app:desc-fleet-dr-yelloweye}

*Discard rate: the fraction of caught fish that are discarded. Uniform distribution lower and upper bounds. Fraction.*

No discard dynamics are modeled. We assume all mortality is accounted for in catch.

```{r desc-fleet-dr-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "DR")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### CurrentYr {#app:desc-fleet-currentyr-yelloweye}

*The current calendar year (final year) of the historical simulations (e.g., 2019).*

```{r desc-fleet-currentyr-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "CurrentYr")
```
<!-- slot-chunk-end -->

## OBS SLOT DESCRIPTIONS {#app:desc-obs-yelloweye}

<!-- slot-chunk-begin -->
### Cobs {#app:desc-obs-cobs-yelloweye}

*Log-normal catch obs observation error expressed as a CV. Uniform distribution lower and upper bounds.*

```{r desc-obs-cobs-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "Cobs")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### Cbiascv {#app:desc-obs-cbiascv-yelloweye}

*Log-normal CV controlling the sampling of bias in catch observations for each simulation. Uniform distribution lower and upper bounds.*

```{r desc-obs-cbiascv-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "Cbiascv")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### Iobs {#app:desc-obs-iobs-yelloweye}

*Observation error in the relative abundance indices expressed as a SD. Uniform distribution lower and upper bounds.*

This was set to 0.25, based on the SD of the observed HBLL index, except for the robustness scenario "(B) Higher HBLL CV" where this was set to the SD and autocorrelation from the index residuals in OM (1) for future projections of the HBLL index (see Section \@ref(sec:approach3-referenceB)).
We can not display this parameter here because it is added in the code as `AddIerr` in the "additional index" functionality of DLMtool.

```{r desc-obs-iobs-yelloweye, results = knitr_results, echo = knitr_echo, eval=FALSE}
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### beta {#app:desc-obs-beta-yelloweye}

*A parameter controlling hyperstability/hyperdepletion where values below 1 lead to hyperstability (an index that decreases more slowly than true abundance) and values above 1 lead to hyperdepletion (an index that decreases more rapidly than true abundance). Uniform distribution lower and upper bounds.*

We set the hyperstability/hyperdepletion $\beta$ parameter to 1 to imply no hyperstability or hyperdepletion. Since we use the `AddInd` feature to generate the index for the management procedures, this is set in `OM@cpars$AddIbeta`.

```{r desc-obs-beta-yelloweye, results = knitr_results, echo = knitr_echo, eval=FALSE}
```
<!-- slot-chunk-end -->

## IMP SLOT DESCRIPTIONS {#app:desc-imp-yelloweye}

<!-- slot-chunk-begin -->
### TACFrac {#app:desc-imp-tacfrac-yelloweye}

*Mean fraction of TAC taken. Uniform distribution lower and upper bounds.*

No implementation error is the assumption.
```{r desc-imp-tacfrac-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "TACFrac")
```
<!-- slot-chunk-end -->

<!-- slot-chunk-begin -->
### TACSD {#app:desc-imp-tacsd-yelloweye}

*Log-normal CV in the fraction of TAC taken. Uniform distribution lower and upper bounds.*

No implementation error is the assumption.

```{r desc-imp-tacsd-yelloweye, results = knitr_results, echo = knitr_echo}
display_om(oms, "TACSD")
```
<!-- slot-chunk-end -->

