# SELECTION OF UNCERTAINTIES/SPECIFICATION OF OPERATING MODELS {#sec:om}

DLMtool OMs are organized into four main components representing a real fished system:

1. population dynamics of the fish stock (e.g., growth, recruitment, mortality);
2. fishery dynamics (e.g., selectivity, spatial targeting);
3. observation processes (e.g., bias and precision in survey indices); and
4. management implementation (e.g., percentage overages of catch limits).

Parameters under the four components are described in detail in Appendix B of @carruthers2018 and Appendix A of @anderson2020gfmp.
DLMtool allows the incorporation of uncertainty in most OM parameters through optional specification of a distribution.
To isolate the effects of specific sources of uncertainty on performance of MPs, we develop alternative OMs that change the value (or distribution) of one or more parameters and/or data sources of interest (see next section).

Best practice recommends calibrating or conditioning OMs with observed data so they can reproduce historical observations.
DLMtool's companion software package, MSEtool [@huynh_msetool_2019], includes an efficient implementation of a stock reduction analysis (SRA) [@kimura1982; @walters2006], which is effectively a catch-at-age model that estimates the combinations of historical fishing mortality and recruitment that would be consistent with the observed data [Appendix B; @anderson2020gfmp].

There are two distinct time-periods in the simulation framework:
(1) the historical period, which includes the years from the first year of the observed catch time-series $t_1$ to the final year of the observed catch time series $t_c$ (where "c" represents the "current" year); and
(2) the projection period, which covers the period from the first year after $t_c$ to the final projection year $t_N$.
The historical period is calibrated to historical observations using an age-structured SRA [Appendix B; @anderson2020gfmp].
The closed-loop simulation, with application of the MPs and calculation of performance metrics, begins in the first year of the projection period (year $t_{c+1}$).

OM development in the MP Framework follows three steps:

1. Set parameter values and ranges in the OM (Appendix \@ref(app:desc-om-yelloweye)).

2. Pass the OM parameters to the SRA model, which conditions the OM by fitting an age-structured SRA to historical observed catches, indices of abundance, and any available years of age-composition data).
This results in calibrated estimates of model parameters and estimates of historical biomass and historical fishing mortality (in years $t_1$ to $t_c$), which are consistent with historical observations.
See Appendix B of @anderson2020gfmp for details.

3. Pass the calibrated parameter values back to the OM (now the "conditioned" OM) for use in the closed-loop simulation projections, starting in year $t_{c+1}$.

Where possible, we derived OM settings for Inside Yelloweye Rockfish from biological data from the inside Hard Bottom Longline (HBLL) survey (Appendix \@ref(app:biological-data)).
We derived other parameters from the scientific literature and stock assessments for Yelloweye Rockfish in other areas.
A list of "default" OM parameter settings recommended for most BC groundfish stocks is provided in @anderson2020gfmp (their Appendix C).

We conditioned the OMs using age-composition data from the inside Hard Bottom Longline (HBLL) survey (Appendix \@ref(app:biological-data)), survey indices (Appendix \@ref(app:index-data)), and commercial and recreational catch data (Appendix \@ref(app:catch-data)).
A full description of OM parameter settings and sources is provided in Appendix \@ref(app:desc-om-yelloweye).
Details on conditioning the OMs are provided below in Section \@ref(sec:approach3-conditioning).
<!-- TODO: delete this last sentence if there is not a separate section -->

## OPERATING MODELS {#sec:approach3-oms}

MSE best practice recommends dividing MSE trials into a "reference set", using a core set of OMs that include the most important uncertainties (e.g., depletion of the stock or range of natural mortality values), and a "robustness set", that capture a wider range of uncertainties that may be less plausible but should nonetheless be explored [@rademeyer2007; and discussion in @anderson2020gfmp].
@anderson2020gfmp recommended presenting performance metrics from the reference and robustness sets separately.
They recommended that, for most results, reference-set performance metrics should be averaged across all reference set scenarios (an "ensemble approach" to integrate across model uncertainties).
They recommended presenting performance metrics from individual robustness-set scenarios separately.
This facilitates visualization of performance of MPs that performed well in the reference set under a set of more diverse assumptions [@rademeyer2007].
Visualization of performance metrics from the robustness and reference sets of OMs are provided in Section \@ref(sec:results).

For Inside Yelloweye Rockfish, we established four reference-set OMs: (1) a baseline OM; (2) an OM reflecting an alternative magnitude of historical catch during the period 1986--2005; (3) an OM allowing for episodic (rare but large) future recruitment; and (4) an OM estimating length selectivity in the HBLL survey (Table \@ref(tab:ye-scen)).
We further established two robustness-set OMs encompassing possible additional sources of uncertainty: (1) an OM that assumes lower natural mortality than the other OMs; and (2) an OM that assumes a higher CV in the future HBLL survey (Table \@ref(tab:ye-scen)).
The base settings for all OMs are provided in Appendix \@ref(app:desc-om-yelloweye).
Unless otherwise stated, the OMs described below differ only in terms of the specific data or parameters described.

```{r ye-scen, results='asis'}
sc <- readRDS(here("mse/om/ye-scenarios2.rds"))
sc <- sc %>%
  select(-order) %>%
  mutate(scenario_human = gsub("\\\n", " ", scenario_human))
  sc %>% select(-scenario) %>%
  csasdown::csas_table(caption = "Inside Yelloweye Rockfish OM scenarios.",
    col_names = c("Scenario name", "Set type")) %>%
  kableExtra::kable_styling(latex_options = c("hold_position"))
```

### REFERENCE SET {#sec:approach3-reference}

The following OMs were developed as the reference set:

#### (1) Base {#sec:approach3-reference1}

The Inside Yelloweye Rockfish stock is indexed by two fishery-independent surveys: the Hard Bottom Longline Survey (Appendix \@ref(app:index-data), Section \@ref(sec:hbll-index-data)) and the Dogfish Survey (Appendix \@ref(app:index-data), Section \@ref(sec:dogfish-index-data)).

The conditioning SRA model exhibited better retrospective behaviour when the SRA model was fit with more weight applied to the Dogfish Survey in the likelihood function (see Section \@ref(sec:approach3-conditioning) below).
*TODO: Quang is this correct? How was the dogfish survey upweighted? If documenting please use the parameter symbols from gfmp Appendix B*

**TODO: upweighted by multiplying the likelihood elements by 4**

In addition, the age-at-full-selectivity for the HBLL survey was fixed at 20 years. *TODO: Why?*  *TODO: what is the parameter for age-at-full-selectivity? Isn't this set using Length at full selectivity? How was this done?*

*TODO: Need to say that selectivity was fixed in all the other gears as well. Where do we provide sources of fixed selectivity parameters in all the gears in the SRA? In the Conditioning models section below? We also need to explain how the SRA can have multiple gears and how this works when passed back to the OM. RF can pull this from GFMP*

Projected recruitment deviations were sampled in log space with standard deviation $\tau = 0.4$ and autocorrelation $\theta_\textrm{AC} = 0.8$, with $\theta_\textrm{AC}$ estimated post-hoc from the SRA model [Appendix A of @anderson2020gfmp].
During the projection period, only the HBLL index is assumed to be available for the MPs, as this index is conducted annually. 
Projecting only one index of abundance is consistent with many data-limited MPs, which only use a single index of abundance (see Appendix \@ref(app:mps)).
The projected index values were generated with standard deviation $\sigma_I = 0.25$ in log space.
This "Base" OM formed the baseline OM, upon which all the other OM scenarios were based.

#### (2) Low catch {#sec:approach3-reference2}

<!-- TODO: SA: I don't think the following is quite right (it is what we intended to do), but we don't actually use the complete catch reconstruction -->
There are two main uncertainties associated with the historical commercial catch time series for Inside Yelloweye Rockfish (details in Appendix \@ref(app:catch-data), Section \@ref(app:com-catch-data)).
These are: (1) aggregated reporting of rockfish as Other Rockfish (ORF) and (2) the magnitude unreported catch that was discarded at sea prior to the introduction of 100% at-sea monitoring in the groundfish longline fleet in 2006 [@stanley2009].
A catch reconstruction was done by @haigh2011, which is used in the other scenarios.
This reconstruction included doubling the nominal catches of Yelloweye Rockfish for the period 1986 until 2005, as industry did not have confidence in the catch data for those years [@dfo2012].
For the "Low catch" scenario, we did not double the nominal catch for the period 1985--2005.
We used the reconstructed catch up to 1985 and the nominal catch from 1986 onwards.

#### (3) Episodic recruitment {#sec:approach3-reference3}

Long-lived, late-maturing species such as Pacific rockfishes often exhibit episodic, or periodic, recruitment strategies, characterized by high fecundity and occasional very large recruitment events [@winemiller1992; @rose2001; @winemiller2005].
For example, very large or even extreme year classes have been estimated for several BC rockfish species [*TODO: examples: POP?, Boccacio, Yelloweye??*].

To address the possibility that future recruitment during the projection period could be characterized by occasional very large recruitment events, we included an "Episodic recruitment" scenario in the reference set of OMs.
This scenario addresses the concern that very large cohorts are not adequately modelled by the lognormal distribution for recruitment deviations used in the baseline OM (Section \@ref(sec:approach3-reference1)).
In this scenario, recruitment deviations $\varepsilon_y$ for each year are generated as:

$$
\varepsilon_y = 
\left\{
\begin{array}{ll}
\varepsilon^1_y & \eta_y = 0\\
\varepsilon^2_y & \eta_y = 1,
\end{array}
\right.
$$

where $\varepsilon^1_y$ is the recruitment deviation from OM 1 and
$\varepsilon^2_y \sim \textrm{Normal}(-0.5\tau^2, \tau)$ represents the "episodic" recruitment distribution with $\tau = 2$ (standard deviation).
The paramater $\eta_y$ is a Bernoulli random variable $\eta_y \sim \textrm{Bernoulli}(p = 1/38)$, which indicates whether an extreme recruitment event will occur. 
One extreme recruitment is expected to occur once every generation (38 years).

#### (4) Estimate HBLL selectivity {#sec:approach3-reference4}

There is a lack of commercial age-composition data for this stock.
Furthermore, annual sample sizes of age-composition data from the HBLL survey are very small (Appendix \@ref(app:biological-data)). 
*TODO: Add Quang's age-comp fits to Conditioning section below*
This makes estimation of selectivity in the HBLL survey highly uncertain, which led to the choice to fix selectivities for the OMs.

Given very uncertainties in our choices of selectivities, we allowed the SRA to estimate selectivity for the HBLL survey in the "Estimate HBLL selectivity" scenario, utilising the available age-composition data.

### ROBUSTNESS SET {#sec:approach3-robustness}

#### (A) Low M {#sec:approach3-referenceA}

The base model assumed mean value of natural mortality *M* of 0.045 $y^{-1}$, drawn 
from a lognormal distribution with $M \sim \textrm{Lognormal}(0.045, 0.2)$.
This was based on the value used in the recent rebuilding plan for the Outside Yelloweye stock [@cox2020]. *TODO: I think this is where it came from*

The "Low M" scenario used $M \sim \textrm{Lognormal}(0.025, 0.2)$, reflecting the possibility that the stock could be less productive than assumed in the reference set scenarios.

#### (B) Higher HBLL CV {#sec:approach3-referenceB}

```{r higher-cv}
SRA_highCV <- readRDS(here::here("mse/om/updog_fixsel.rds"))
Iobs <- SRA_highCV@OM@cpars$Data@AddInd[1, , ] %>% t()
Ipred <- lapply(SRA_highCV@Misc, getElement, "Ipred")
Isd <- rbind %>% do.call(lapply(Ipred, function(x, y) apply(log(y/x), 2, function(xx) sd(xx, na.rm = TRUE)), y = Iobs))
mean_Isd <- mean(Isd[,1])
range_Isd <- range(Isd[,1])
```

The "Higher HBLL CV" scenario considers the possibility the HBLL index might be less precise than assumed based on the stratified bootstrap procedure used to estimate the observation CV.
Instead of an observation SD of 0.25, we use the SD and autocorrelation from the index residuals in OM (1) for future projections of the HBLL index.
This SD has a mean of `r round2(mean_Isd)` and a range of `r round2(range_Isd[1])`--`r round2(range_Isd[2])`.

## CONDITIONING THE OPERATING MODELS {#sec:approach3-conditioning} 

After specifying most of the OM parameters (Appendix \@ref(app:desc-om-yelloweye)), we conditioned the OMs using the SRA model described in Appendix B of @anderson2020gfmp.

Note that DLMtool currently models all catch as coming from a single fleet.
However, if the OM is calibrated using the SRA model, the SRA can accommodate multiple fleets, and selectivity is fleet-specific.
In this case, selectivity in the DLMtool OM in the projection period is replaced with the SRA-calibrated estimate of fishing mortality-at-age in the final year ($t_c$) of the historical period, normalized by dividing by apical fishing mortality in that year.
This essentially provides the DLMtool OM with selectivity-at-age weighted by catch across all fleets.
The closed-loop simulation projections therefore assume that the relative selectivities across fleets remains constant in the projection period.

Similarly, if the OM is calibrated using the SRA model, analysts can also specify (or estimate) selectivity parameters for the individual indices of abundance (in this case two fishery-independent surveys and three commercial CPUE series (Figure \@ref(fig:survey-fits)).
In this case, the SRA passes all of the indices back to DLMtool, preserving the estimated or user-defined selectivities-at-age for each index.
However, note that the DLMtool MPs only utilize a single index of abundance in the projection period for calculating catch decisions (see Appendix \@ref(app:mps)). In the current study, all MPs (except for the constant-catch MPs) utilize the HBLL survey.


The SRA model was used to condition the following OM parameters: <!--not sure these are the correct ones below -->

* unfished recruitment
* depletion
* relative fishing effort
* annual recruitment deviations
* selectivity parameters

*TODO: edit this whole section and also see Quang's notes in mse/mse-bullets*

*from Quang*
-

General settings:
- Max age = 80 years (plus group accumulator age)
- Use SRA model (cite gfmp)
- Each replicate fits a different value of M and h (sampled independently)
- Fix selectivity of fisheries to values from outside YE. Use hook and line for commercial (there is little to no trawl fishery for inside pop)
- Estimate rec devs after 1950 (age comps only available after 2003)
- Estimate HBLL selectivity. Mirror the dogfish selectivity in each replicate to match that for HBLL
- Multinomial annual sample size for age comps based on the number of sampling trips.

*Note about Low catch fit*

to address uncertainty in historical catch, an alternative scenario was used where the 1986-2005 commercial catch was not doubled, and instead the gfdatabase records of commerical catch were used. Compared to (1), this OM implies a relatively smaller stock that has been fished more heavily. Between 1 and 2, relatively large extremes in assumed catches are used to illustrate the effect of catch uncertainty.

*TODO: how much do we need to talk about the initial fit which we are not using?*

- Initial fit did not fit dogfish survey well. Retrospective analysis showed bias in SSB (For model with M and h set to mean priors, rho = 0.25 for 11 years when removing up to 11 years of data). 11 years of data were used primarily to evaluate consistency of the model going back to 2009 which was the terminal year for the 2011 assessment.

- Subsequent that increased likelihood weight (lambda = 4) to dogfish survey also removed retrospective bias (SSB rho = -0.05). However, HBLL age of full selectivity was estimated to be 40+ years, which is inconsistent with the age comps. This is though to be unlikely, since the modes of the HBLL age compars around 20 years, which was what was estimated in the initial fit in previous paragraph, and is also the estimated full selectivity for the HL gear in the outside population.

- Next, it was decided to fix the HBLL selectivity to that from the initial fit while also upweighting the dogfish survey. This fit generated small retrospective bias (SSB rho = -0.07) for the fit with M and h mean priors.

- Retrospective bias among these fits vary depending on the assumption of M, with larger bias at higher M. This is another uncertainty associated with the OM conditioning process.
<!-- I will generate a plot of SSB rho vs. M to show this -->

To isolate the effects of specific sources of uncertainty on performance of MPs, alternative OMs were developed that changed the value (or distribution) of one parameter or data source of interest. OMs are divided into a reference set of core OMs representing the most important plausible model uncertainties, and a robustness set for testing sensitivity to a broader range of structural uncertainties [@rademeyer2007].

The SRA was able to fit to the HBLL survey relative biomass index and TODO indices reasonably well for all OM scenarios (Figure \@ref(fig:survey-fits)).
The TODO survey was better fit than the TODO, likely due to TODO (Figure \@ref(fig:survey-fits)).

The SRA models fit the catch data almost perfectly by design, via setting the standard deviations of the observation error to a value of 0.01 [@anderson2020gfmp, their Equation B.27].

(ref:fig-survey-fits)
SRA model fits to the HBLL, Dogfish, and three commercial CPUE relative  indices.
Panels from left to right represent OM scenarios.
Thin lines represent individual SRA model fits across stochastic draws from the various OM parameters.
Dots represent index mean and line segments represent 2 times the standard errors as entered into the SRA models.

```{r survey-fits, fig.cap="(ref:fig-survey-fits)", out.width="\\textwidth"}
knitr::include_graphics(here("mse/figures/ye-index-fits.png"))
```

We used the SRA to populate the following parameters in the conditioned OMs:

- $B_{t_c}/B_0$ (or "D"; depletion in the last historical year)
- $R_0$ (unfished recruitment)
- $\theta_\textrm{AC}$ (or "AC"; first-order autocorrelation of recruitment deviations)
- $F_{a,y}$ (fishing mortality at age by year)
- $\varepsilon_{\textrm{R},y}$ for years $t_1$ to $t_c$ (historical recruitment deviations)

The reference and robustness scenarios rendered a range of estimated parameter values (Figure \@ref(fig:sra-conditioned-parameters)).

Since all the replicate SRA models converged, we do not show the filtered parameters---they correspond exactly to those described in Appendix \@ref(app:desc-om-yelloweye).

TODO: note that all replicates converged

Other key parameters that were possibly affected by the SRA (but there wasn't any filtering) (Figure \@ref(fig:sra-conditioned-parameters2)).

The implied spawning stock biomass depletion trajectories during the historical period from the eight OMs were TODO (Figure \@ref(fig:depletion-om)).


```{r sra-fraction, results='asis', eval=FALSE}
# This just checks that all replicas converged
rex_converged <- readRDS(here("mse/om/ye-converged.rds"))
rex_converged %>%
  mutate(fraction_converged = sprintf("%.2f",round(nsim / 250, 2))) %>%
  mutate(scenario = gsub("\\n", " ", scenario)) %>%
  select(-nsim) %>%
  csasdown::csas_table(col_names = c("Scenario", "Fraction retained"),
    caption = "Fraction of replicates retained after conditioning with the SRA model.")
```

*TODO: make ye-sra-estimated.png and ye-sra-filtered.png*

(ref:fig-sra-conditioned-parameters) Histograms of parameters estimated by the SRA. Other parameters: Fishing mortality at age, the historical depletion trajectory, and historical recruitment deviations are also derived from the SRA model. Historical depletion trajectories are shown in Figure \@ref(fig:depletion-om), apical fishing mortality by year are shown in Figure \@ref(fig:F-om), and historical recruitment deviations are shown in Figure \@ref(fig:recdev-om).
D refers to depletion. AC refers to $\theta_\textrm{AC}$.

```{r sra-conditioned-parameters, out.width="0.85\\textwidth", fig.cap="(ref:fig-sra-conditioned-parameters)"}
knitr::include_graphics(here("mse/figures/ye-sra-estimated.png"))
```

(ref:fig-sra-conditioned-parameters2)
Frequency polygons for parameters input to the SRA. Parameters were sampled stochastically as input into the SRA (see Appendix \@ref(app:desc-om-rex) for ranges). Any samples associated with non-converged SRA models were discarded. Since all SRA models converged, these distributions are the same across scenarios unless they were specified differently in the OM. The large spikes represent fixed parameter values in the OM. sigma_R refers to $\sigma_R$.

```{r sra-conditioned-parameters2, out.width="\\textwidth", fig.asp=0.85, fig.width=7, eval=FALSE, fig.cap="(ref:fig-sra-conditioned-parameters2)"}
knitr::include_graphics(here("mse/figures/ye-sra-filtered.png"))
```

\clearpage

(ref:fig-depletion-om)
Spawning stock biomass ($B$) depletion trajectories for reference and robustness set OMs.
Depletion is represented as a fraction of $B_0$ (spawning stock biomass at unfished equilibrium).
Lines represent medians, and dark and light grey shading represent 50% and 95% quantiles across replicates.

```{r depletion-om, fig.cap="(ref:fig-depletion-om)", out.width="\\textwidth"}
knitr::include_graphics(here("mse/figures/ye-compare-SRA-depletion-panel.png"))
```

(ref:fig-F-om)
Apical fishing mortality ($F$) trajectories for reference and robustness set OMs.
Apical fishing mortality is the maximum $F$ experienced by fish of any age in a given year.
Lines represent medians, and dark and light grey shading represent 50% and 95% quantiles across replicates.

```{r F-om, fig.cap="(ref:fig-F-om)", out.width="\\textwidth"}
knitr::include_graphics(here::here("mse/figures/ye-compare-SRA-F-panel.png"))
```

(ref:fig-recdev-om)
Historical recruitment deviations estimated by the SRA model (in log space).
Lines represent 100 random samples from the replicates.

```{r recdev-om, fig.cap="(ref:fig-recdev-om)", out.width="\\textwidth"}
knitr::include_graphics(here::here("mse/figures/ye-compare-SRA-recdev-panel.png"))
```

