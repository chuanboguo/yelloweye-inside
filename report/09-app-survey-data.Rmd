# FISHERY-INDEPENDENT SURVEY DATA {#app:index-data}

## HBLL INSIDE SURVEY INDEX {#sec:hbll-index-data}

The Hard Bottom Long Line (HBLL) survey for the Strait of Georgia management area (4B) has been providing catch-rate indices and associated biological data for inshore rockfish assessment since 2003 [@lochead2007].
The survey is a depth-stratified random design of 2km by 2km survey blocks, which has always taken place on the CCGS Neocaligus vessel.
The survey uses snap-type circle hooks and squid bait with a two-hour soak time.
Hook-by-hook data is collected on-board by DFO technicians and stored in a database.
For further details on survey design see @lochead2004.

The survey domain is divided into northern and southern regions, which are fished in alternating years so that each area is designed to be sampled every other year.
However, several irregularities have occurred (Figure \@ref(fig:hbll-raw)):
- The survey did not take place in 2006 and 2017.
- The length of the survey has varied and has lead to inconsistencies in the geographic extents surveyed.
- Desolation Sound, which falls between the northern and the southern regions, is supposed to be sampled in the southern region, but was sampled along with the northern region in 2003, 2008, and 2019, and not sampled in 2009 and 2018. The Yelloweye Rockfish catch rates are highest in Desolation Sound (Area 15) so not sampling there we expected to affect design-based survey estimates of the southern survey.
- The full southern survey was not achieved in 2009 and only 38 stations were fished in the southern Strait of Georgia between Nanaimo and Victoria. Catch rates of most rockfish species caught on this survey decline from the north to the south, so this also has a major effect on the survey index.

For these reasons, we chose to undertake a geostatistical spatiotemporal model standardization of the HBLL index [e.g., @shelton2014; @thorson2015; @anderson2019synopsis] to account for the irregular implementation of the survey design.
Theoretically, such an approach can account for the above factors.
We confirmed via simulation that such approach can "stitch" together two survey regions conducted in a north and south region (REF section).

### Hook competition {#sec:hbll-hook-competition}

A longline index of species abundance may not be proportional to actual abundance under certain conditions.
For example, if there is a high degree of competition among species for baited hooks, the actual catch may not accurately reflect the true abundance of less competitive species [@kuriyama2018]. The HBLL survey catch is mostly comprised of Pacific Spiny Dogfish (TODO SP), which are considered a major hook competitor with rockfishes [@obradovich2018].
As in @yamanaka2011, we applied a hook competition model, which accounts for the competition between individual fish for the bait on hooks, to the HBLL Inside survey data.
Hook-by-hook catch data have always been collected on this survey.
To apply the model, we applied a competition adjustment factor to each set in each year, which scales up the observed number of each species caught to give the expected number of fish caught after accounting for competition.

The adjustment factor depends on the proportion of observed hooks that are returned with bait still on them:

TODO: add the equation here:
hook_adjust = - log(Pit) / (1 - Pit)

<!-- mutate(total_hooks = count_target_species + count_non_target_species + -->
<!--     count_bait_only + count_empty_hooks - count_bent_broken) %>% -->
<!--   mutate(count_bait_only = replace(count_bait_only, which(count_bait_only == 0), 1)) %>% -->
<!--   mutate(prop_bait_hooks = count_bait_only / total_hooks) %>% -->
<!--   mutate(hook_adjust_factor = -log(prop_bait_hooks) / (1 - prop_bait_hooks)) %>% -->
<!--   mutate(expected_catch = round(count_target_species * hook_adjust_factor)) -->

where P_it is the proportion of observed hooks for set i in year t returned with bait on them.

In instances where zero hooks were returned with bait the number of baited hooks returned was set to one.
The hook adjusted data (observed numbers) were then passed to the spatiotemporal model to develop the index of abundance.

Reference these figures:

Figure \@ref(fig:hbll-baited)

Figure \@ref(fig:hbll-hook-adjustment)

### Spatiotemporal HBLL index standardization

We can represent our geostatistical standardization model as:

\begin{align}
  y_{s,t} &\sim \mathrm{NegBin}(\mu_{s,t}, \phi),\\
  \mu_{s,t} &= \exp \left( \bm{X}_{s,t} \bm{\beta} + \omega_s + \epsilon_{s,t} \right),
\end{align}

where NegBin refers to the negative binomial distribution (the NB2 parameterization [@hilbe2011] where the variance scales quadratically with the mean),
$\mu_{s,t}$ refers to the expected value in log space at spatial point $s$ and time $t$,
$\phi$ refers to the dispersion parameter, $\bm{X}$ refers to a design matrix, and
$\beta$ refers to estimated coefficients (an independent mean for each year).
The spatial random effects ($\omega_s$) are assumed to be drawn from a multivariate normal distribution with some covariance matrix $\bm{\Sigma}_\omega$:

$$
\bm{\omega} \sim \mathrm{MVNormal} \left( \bm{0}, \bm{\Sigma}_\omega \right),
$$

and we assume the same for the spatiotemporal random effects, with each time slice being given its own independent set of random effects ($\bm{\epsilon}_t$) with covariance matrix $\bm{\Sigma}_{\epsilon,t}$:

$$
\bm{\epsilon}_t \sim \mathrm{MVNormal} \left( \bm{0}, \bm{\Sigma}_{\epsilon,t} \right).
$$

We allowed for anisotropy in the spatial and spatiotemporal correlation (REF).
This allows the spatial correlation to decay at different rates north to south and east to west.
The spatial random effects account for spatial factors that are constant across time, for example, depth and substrate type.
The spatiotemporal random effects account for factors that vary from year to year spatially such as bottom temperature, water circulation patterns, species interactions, and species movement.
As sensitivity analyses, we included alternate versions of our models that (1) also included for depth and (2) did not account for hook competition.

We fit our model with TMB [@tmb], by ... *TODO*
We checked that the models were consistent with convergence by checking that the maximum gradient across all estimated coefficients was < 0.001 and that the covariance matrix was positive-definite.

We can project predictions from the model to the full survey domain (Figure \@ref(fig:hbll-area-grid)) using the covariance projection matrix Figure \@ref(fig:hbll-predicted-spacetime).
We can also look at the individual components of the model.
The spatial random effects are constant across years (Figure \@ref(fig:hbll-spatial-re)) and the spatiotemporal random effects vary across years (Figure \@ref(fig:hbll-spatiotemporal-re)).

We can then calculate expected biomass $B_t$ in year $t$ as:

$$
B_t = \sum_{j = 1}^{n_j}
  w_j \cdot \exp \left( \bm{X}_{j,t} \bm{\beta} + \omega_j + \epsilon_{j,t} \right),
$$

where $j$ references a grid cell within the survey domain and $w_j$ represents the area of that grid cell (Figure \@ref(fig:hbll-area-grid)).
In other words, we sum the predicted biomass across all grid cells within the survey domain for each year.
We generated standard errors on the annual estimates of log biomass via the generalized Delta method as implemented in TMB [@tmb].

The resulting standardized population index accounts for the irregular sampling of the survey domain and hook competition and "stitches" the northern and southern regions into a single population index (Figure \@ref(fig:hbll-index)).
The inclusion of depth or the exclusion of the hook competition adjustments had relatively minor effects on the population index (Figure \@ref(fig:hbll-index)).
The model is also able to "fill in" what the index might hypothetically look like for the northern and southern regions independently (Figure \@ref(fig:hbll-index)).

We undertook a basic simulation analysis to test that our approach of "stitching" northern and southern regions into a single survey domain was reasonable from a statistical perspective.
We generated a system that roughly matches the HBLL survey data we worked with in this document.
TODO: list the parameter values
TODO: list the number of samples each year
TODO: Poisson for simplicity
We simulated an underlying true mean abundance on a square polygon.
We then discarded the northern and southern regions in alternating years and attempted to fit a similar spatiotemporal model to the one used for the HBLL index standardization (Figure \@ref(fig:stich-sim-pred)).

Despite the model only seeing alternating northern and southern regions, the model was able to reconstruct the unobserved missing portions based on the estimated spatial correlation, and to a lesser extent of the estimated spatiotemporal correlation
 (Figure \@ref(fig:stich-sim-pred)).
By projecting the model predictions onto a grid over the full area of the simulated square, our model was able to produce an index that was similar to the true index (Figure \@ref(fig:stich-sim-index)).
If we instead naively generated the index using an approach to mimic a design-based approach (by summing the observed abundances each year), the resulting index does not reflect the true index in many years (Figure \@ref(fig:stich-sim-index)).

Through experimentation (not shown) we found that the stitching is most accurate at recapturing the true index if the magnitude of spatial correlation deviations ($\omega_s$) is much larger than the magnitude of spatiotemporal correlation deviations ($\epsilon_{s,t}$).
This is the case in our HBLL model, where the marginal standard deviation of $\omega_s$ was approximately six times larger than the marginal standard deviation of $\epsilon_{s,t}$.

```{r}
include_figs <- function(file) {
  knitr::include_graphics(here::here("figs", file), dpi = NA)
}
```

```{r hbll-raw, fig.cap="Inside HBLL survey observations of Yelloweye Rockfish. Gray background shading indicates the northern and southern survey areas. The area of the circles represents the number of fish caught per hook after accounting for hook competition.", out.width="\\textwidth"}
include_figs("hbll-joint-raw-data.png")
```

```{r hbll-area-grid, out.width="5in", fig.cap="Area per survey grid cell that is in water for the inside HBLL survey. The predicted count density for each grid cell is scaled up to the full survey domain based on these areas."}
include_figs("hbll-area-in-water.png")
```

```{r hbll-baited, fig.cap="Proportion baited hooks returned for the inside HBLL survey. Note the substantial difference between the northern and southern areas and the change in the north between 2003--2007 in subsequent years.", out.width="\\textwidth"}
include_figs("hbll-joint-baited.png")
```

```{r hbll-hook-adjustment, fig.cap="Hook adjustment factor for the inside HBLL survey accounting for the number of hooks and the number of returned baited hooks.", out.width="\\textwidth"}
include_figs("hbll-joint-hook-adjust.png")
```

```{r hbll-predicted-spacetime, fig.cap="Predicted relative density in space and time for the inside HBLL survey. Observed (hook-adjusted) counts are illustrated with circles. Predictions are illustrated with colour shading.", out.width="\\textwidth"}
include_figs("hbll-joint-prediction-log.png")
```

```{r hbll-spatial-re, fig.cap="The spatial random effects. These are consistent spatially correlated differences in expected abundance through time. The values are shown in link (log) space.", out.width="4.2in"}
include_figs("hbll-joint-omega.png")
```

```{r hbll-spatiotemporal-re, fig.cap="The spatiotemporal random effects. These are spatially correlated deviations that change through time. Note the reversion to the mean in area-year combinations without sampling data. Note the difference in magnitude between the spatial random effects (previous figure) and these spatiotemporal random effects.", out.width="\\textwidth"}
include_figs("hbll-joint-epsilon.png")
```

```{r hbll-index, out.width="4in", fig.cap="The joint relative abundance index. Top panel shows the joint prediction from the spatial temporal model. Included are three versions: (1) random effects and annual means only, (2) adding a depth covariate, and (3) removing the hook adjustment factor. The middle and bottom panels show the joint predictions for the northern and southern areas. All shaded regions represent 95\\% confidence intervals. The joint index timeseries in the top panel have been scaled to have the same geometric mean as the main ``HBLL INS'' index for visualization purposes. In the second and third rows, the solid dots represent years with observations and the open dots represent years without observations. Similarly, the dashed vertical lines indicate years with surveys (mostly) in the southern area."}
include_figs("hbll-index-components-eps-depth2.png")
```

\clearpage

```{r stich-sim-pred, fig.cap="Simulation testing the relative abundance index calculation with alternating north and south observations. (A) The true simulated (mean) abundance in space and time. (b) The observed (dots) and estimated (colour) counts in space and time from the geostatistical model. The observations occur in north and south regions in alternating years and are ``blind'' to the missing region. Notice how the spatial temporal model is able to predict what the abundance should be in the ``blind'' region based on the consistent spatial correlation pattern (and to a lesser degree the spatiotemporal correlation pattern).", out.width="\\textwidth"}
include_figs("geostatistical-sim-predicted.png")
```

\clearpage

```{r stich-sim-index, fig.cap="Simulation testing the relative abundance index calculation with alternating north and south observations. The solid red line represents the true simulated abundance through time. The dashed and dotted green line represents a ``naive'' design-based estimate, which is calculated here by calculating the abundance with just the observed north or south counts in each year. The dashed blue line represents a geostatistical standardized index that attempts to account for the north-south biennial observations. The shaded blue region represents the modelled 95\\% confidence interval.", out.width="5in"}
include_figs("geostatistical-sim-stitched-index.png")
```

\clearpage

## DOGFISH SURVEY INDEX {#sec:dogfish-index-data}

The Pacific Spiny Dogfish (*Squalus suckleyi*) survey samples nine locations in the Strait of Georgia that were historically fished by the commercial Dogfish fishery [@king2012].
The survey was first carried out in 1986, with subsequent sampling in 1989, 2005, 2011, 2014, and 2019.
The survey is a depth stratified longline survey that uses snap on gear with 300 circle hooks baited with Pacific Herring and a two hour soak time.
A more detailed description of survey methods is provided in [@king2012].
For most of the time series, set-by-set catch of Rockfish has been recorded.
Beginning in 2019, hook-by-hook data for all captured species was collected on board by DFO technicians, along with biological data for Rockfish.
We use a spatiotemporal model to estimate the density of Yelloweye Rockfish per km^2^. We calculate the area swept by multiplying the number of hooks deployed by the estimated width swept by the length of two gagnions and the estimated distance between hooks (8ft spacing).

### Hook comparison {#sec:dog-hook-comparison}

The survey fished with J-hooks originally and then changed to Circle-hooks in 2005.
In 2004, @mcfarlane2005 undertook a calibration study to assess the potential for a change in catch rates due to a switch from J-hooks to circle hooks.
The study only compared catch rates for Spiny Dogfish; however, the hook change likely affected catchability for Yelloweye Rockfish differently than for Spiny Dogfish.
In the previous assessment, a catchability ratio was estimated using data for all rockfish and this ratio was used to scale the values in the 1980s.
It is not clear from the previous assessment how this catchability ratio was estimated.
The previous assessment was quite sensitive to the resulting Dogfish index (because of the large decline from the 1980s), and that decline was largely dependent on the hook ratio.
In the current analysis, we standardize the population index using a spatiotemporal geostatistical model that accounts for spatial and spatiotemporal correlation in Yelloweye Rockfish abundance while simultaneously accounting for the number of dogfish caught (to partially correct for hook competition) and estimating a correction factor for the hook change.
By estimating the correction factor simultaneously with the standardization model, we are able to incorporate uncertainty in the correction factor into the resulting index standard errors.

### Depth {#sec:dog-depth}

In addition to the survey not being designed for rockfishes, and the change in gear type, the shallower depth stratum was dropped in 2004 and later surveys.
This was done to purposely try to avoid catching Rockfish (because of conservation concerns).
While depth is not explicitly included in the spatiotemporal model, the spatial random effects should absorb much of the variation driven by depth will also accounting for other spatially varying effects.

### Hook competition {#sec:dog-hook-competition}

The previous inside Yelloweye Rockfish assessment notes using an exponential hook competition model on the dogfish survey data in 2011.
However, there are no data on the number of baited and empty hooks available for the Dogfish survey prior to 2019 and the previous assessment does not indicate how they accounted for this.
Therefore, a hook competition model was not applied to the dogfish survey data in the present analysis.
To partially account for hook competition, we include the number of dogfish caught (log transformed so is to have a multiplicative effect) as a covariate in the model.

### Selectivity {#sec:dog-selectivity}

**The circle hooks used now are one size bigger than on HBLL and who knows what the selectivity was with the j-hooks! No rockfish biological data were formerly collected. So, in absence of info, I think we can use the same selectivity as long as we acknowledge the uncertainty (This is a note from one of Dana's emails but I'm not sure what was actually decided for selectivity-MJB)**

### Spatiotemporal dogfish survey index standardization

We use a similar geostatistical model to that described for the HBLL survey (REF).
with the addition of dogfish and hook-type covariates.
Our model includes spatiotemporal random effects ($\epsilon_{s,t}$; defined for locations in space $s$ and time $t$
and annual predictors for the mean biomass each year:

\begin{align}
  y_{s,t} &\sim \mathrm{Tweedie}(\mu_{s,t}, p, \phi), \quad 1 < p < 2,\\
  \mu_{s,t} &= \exp \left( \bm{X}_{s,t} \bm{\beta} + \omega_s + \epsilon_{s,t} \right).
\end{align}

The spatial random effects ($\omega_s$) are assumed
to be drawn from a multivariate normal distribution with some covariance matrix
$\bm{\Sigma}_\omega$:

$$
\bm{\omega} \sim \mathrm{MVNormal} \left( \bm{0}, \bm{\Sigma}_\omega \right),
$$

and we assume the same for the spatiotemporal random effects, with each time
slice being given its own independent set of random effects ($\bm{\epsilon}_t$)
with covariance matrix $\bm{\Sigma}_{\epsilon,t}$:

$$
\bm{\epsilon}_t \sim \mathrm{MVNormal} \left( \bm{0}, \bm{\Sigma}_{\epsilon,t} \right).
$$

<!-- m <- sdmTMB( -->
<!--   formula = -->
<!--     ye_count ~ 0 + circle_hook_centered + -->
<!--     as.factor(year) + -->
<!--     log(dogfish_count) + offset, -->
<!--   data = d_utm, -->
<!--   spde = sp, -->
<!--   time = "year", -->
<!--   silent = FALSE, -->
<!--   anisotropy = TRUE, -->
<!--   reml = TRUE, -->
<!--   family = nbinom2(link = "log") -->
<!-- ) -->


<!--
**Sean's notes**
Notes:

I'm estimating the index for an "average" hook type. If we estimate for one or the other type then it puts more or less uncertainty into the first or second half of the time series (the estimates themselves are just scaled though).

It is now able to estimate spatiotemporal random effects and with the help of the spatial correlation it seems to be better able to estimate the hook type correction with appropriate uncertainty. You can see the estimated correction factor in the model output:

exp(2.04)
[1] 7.690609

exp(2.04 + c(-2, 2) * 0.80)
[1]  1.552707 38.091837

I'm sure thats an exaggeration, but so it is with few data points and no priors. At least by including it in one model we can let the data speak for themselves.

I am creating the index on the rectangles that define the dogfish survey. I overlaid a 500m x 500m grid on the dogfish survey rectangles and am now also removing any of those fine scale grid cells that overlap land.
-->

\clearpage

```{r, fig.cap="Raw data", out.width="\\textwidth"}
include_figs("dogfish-yelloweye-per-area-data.png")
```

```{r, fig.cap="Prediction with log transformed color scale.", out.width="\\textwidth"}
include_figs("dogfish-prediction-log.png")
```

```{r, fig.cap="Spatial random effects.", out.width="4.2in"}
include_figs("dogfish-omega.png")
```

```{r, fig.cap="Spatiotemporal random effects.", out.width="\\textwidth"}
include_figs("dogfish-epsilon.png")
```

```{r, fig.cap="Standardized index.", out.width="5in"}
include_figs("dogfish-index-estimated-hook.png")
```

\clearpage
