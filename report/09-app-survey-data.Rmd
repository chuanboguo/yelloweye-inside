# FISHERY-INDEPENDENT SURVEY DATA {#app:index-data}

## HBLL INSIDE SURVEY INDEX {#sec:hbll-index-data}

The Hard Bottom Long Line (HBLL) survey for the Strait of Georgia management area (4B) has been providing catch-rate indices and associated biological data for inshore rockfish assessment since 2003 [@lochead2007].
The survey is a depth-stratified random design of 2km by 2km survey blocks, which has always taken place on the CCGS Neocaligus vessel.
The survey uses snap-type circle hooks and squid bait with a two-hour soak time.
Hook-by-hook data is collected on-board by DFO technicians and stored in a database.
For further details on survey design see @lochead2004.

The survey domain is divided into northern and southern regions, which are fished in alternating years.
However, several irregularities have occurred (Figure \@ref(fig:hbll-raw)):

- The survey did not take place in 2006 and 2017.
- The length of the survey has varied and has lead to inconsistencies in the geographic extents surveyed.
- Desolation Sound, which falls between the northern and the southern regions, is supposed to be sampled in the southern region, but was sampled along with the northern region in 2003, 2008, and 2019, and not sampled in 2009 and 2018. The Yelloweye Rockfish catch rates are highest in Desolation Sound (Area 15) so not sampling there we expected to affect design-based survey estimates of the southern survey.
- The full southern survey was not achieved in 2009 and only 38 stations were fished in the southern Strait of Georgia between Nanaimo and Victoria. Catch rates of most rockfish species caught on this survey decline from the north to the south, so this also has a major effect on the survey index.

For these reasons, we chose to undertake a geostatistical spatiotemporal model standardization of the HBLL index [e.g., @shelton2014; @thorson2015; @anderson2019synopsis] to account for the irregular implementation of the survey design.
Theoretically, such an approach can account for the above factors.
We confirmed via simulation that such approach can "stitch" together two survey regions conducted in a north and south region (Section \@ref(sec:hbll-sim)).

### Hook competition {#sec:hbll-hook-competition}

A longline index of species abundance may not be proportional to actual abundance under certain conditions.
For example, if there is a high degree of competition among species for baited hooks, the actual catch may not accurately reflect the true abundance of less competitive species [@kuriyama2018]. 
The HBLL survey catch is mostly comprised of Pacific Spiny Dogfish (*Squalus suckleyi*), which are considered a major hook competitor with rockfishes [@obradovich2018].
As in @yamanaka2011, we applied a hook competition correction, which accounts for the competition between individual fish for the bait on hooks, to the HBLL Inside survey data.
Hook-by-hook catch data have always been collected on this survey.
To apply the correction, we applied a competition adjustment factor to each set in each year.
This adjustment factor scales up the observed number of each species caught to give the expected number of fish caught after accounting for competition.

The adjustment factor depends on the proportion of observed hooks that are returned with bait still on them (Figure \@ref(fig:hbll-baited)):

TODO: add the equation here:
hook_adjust = - log(Pit) / (1 - Pit)

<!-- mutate(total_hooks = count_target_species + count_non_target_species + -->
<!--     count_bait_only + count_empty_hooks - count_bent_broken) %>% -->
<!--   mutate(count_bait_only = replace(count_bait_only, which(count_bait_only == 0), 1)) %>% -->
<!--   mutate(prop_bait_hooks = count_bait_only / total_hooks) %>% -->
<!--   mutate(hook_adjust_factor = -log(prop_bait_hooks) / (1 - prop_bait_hooks)) %>% -->
<!--   mutate(expected_catch = round(count_target_species * hook_adjust_factor)) -->

where $P_{i,t}$ is the proportion of observed hooks for set $i$ in year $t$ returned with bait on them.
In instances where zero hooks were returned with bait, we set the number of baited hooks to one.
We passed the hook-adjusted data (Figure \@ref(fig:hbll-hook-adjustment)) to the spatiotemporal model to develop the index of abundance.

### Spatiotemporal HBLL index standardization {#sec:hbll-spatiotemporal}

We fit a geostatistical spatiotemporal index-standardization model:

\begin{align}
  y_{s,t} &\sim \mathrm{NegBin}(\mu_{s,t}, \phi),\\
  \mu_{s,t} &= \exp \left( \bm{X}_{s,t} \bm{\beta} + \omega_s + \epsilon_{s,t} \right),
(\#eq:hbll-model)
\end{align}

where NegBin refers to the negative binomial distribution (the NB2 parameterization [@hilbe2011] where the variance scales quadratically with the mean),
$\mu_{s,t}$ refers to the expected value in log space at spatial point $s$ and time $t$,
$\phi$ refers to the dispersion parameter, 
$\bm{X}$ refers to a design matrix, and
$\beta$ refers to estimated coefficients (an independent mean for each year).
The spatial random effects ($\omega_s$) were assumed to be drawn from a multivariate normal distribution with a covariance matrix $\bm{\Sigma}_\omega$:

$$
\bm{\omega} \sim \mathrm{MVNormal} \left( \bm{0}, \bm{\Sigma}_\omega \right).
$$

We constrained the spatial random effects to follow a \mbox{Mat\'ern} covariance
function, which defines the rate with which spatial correlation decays with
distance.
The \mbox{Mat\'ern} function describes the covariance $\Phi \left( s_j, s_k \right)$ between spatial locations $s_j$ and $s_k$ as:

$$\Phi\left( s_j,s_k \right) = \tau^2/\Gamma(\nu)2^{\nu - 1}
    (\kappa d_{jk})^\nu K_\nu \left( \kappa d_{jk} \right),$$

where $\tau^2$ represents the spatial variance, $\Gamma$ represents the Gamma
function, $K_\nu$ represents the Bessel function, $d_{jk}$ represents the
Euclidean distance between locations $s_j$ and $s_k$, and $\kappa$ represents
a scaling parameter that is estimated [e.g., @lindgren2011]. The parameter $\nu$
controls the smoothness of the covariance function. We set $\nu = 1$, which
lets us take advantage of the Stochastic Partial Differential Equation (SPDE)
approximation to Gaussian Markov Random Fields (GMRF) to greatly increase
computational efficiency [@lindgren2011].

We assumed the same structure for the spatiotemporal random effects, with each time slice being given its own independent set of random effects ($\bm{\epsilon}_t$) with covariance matrix $\bm{\Sigma}_{\epsilon,t}$:

$$
\bm{\epsilon}_t \sim \mathrm{MVNormal} \left( \bm{0}, \bm{\Sigma}_{\epsilon,t} \right).
$$

This covariance matrix is also constrained to follow a \mbox{Mat\'ern} covariance
function with the same $\kappa$ but its own $\tau^2$ (spatial variance).
Although we described the \mbox{Mat\'ern} function above using the simple isometric form for simplicity (spatial correlation is the same in all directions), we actually allowed for anisotropy in the spatial and spatiotemporal correlation [e.g., @thorson2015].

The spatial random effects accounted for spatial factors that were constant across time, for example, depth and substrate type.
The spatiotemporal random effects accounted for factors that varied from year-to-year spatially such as bottom temperature, water circulation patterns, species interactions, and species movement.
As sensitivity analyses, we included alternate versions of our models that (1) also included for depth and (2) did not account for hook competition.

We fit our model with the sdmTMB R package [@sdmtmb] and TMB [@tmb] using a "mesh" with 400 predictive-process "knots" generated by INLA [@lindgren2011; @rue2016] (Figure \@ref(fig:hbll-spde)) and estimating the fixed effects via maximum likelihood with the random effects set to the value that maximized the joint likelihood conditional on the estimated value of fixed effects.
We checked that the model fits were consistent with convergence by checking that the maximum gradient across all estimated coefficients was < 0.001 and that the covariance matrix was positive-definite.

We projected predictions from the model to the full survey domain (Figure \@ref(fig:hbll-area-grid)) using the covariance projection matrix and the binlinear interpolation mesh provided by INLA [@lindgren2011; @rue2016] (Figures \@ref(fig:hbll-spde) and \@ref(fig:hbll-predicted-spacetime)).
In terms of the model components, the spatial random effects were, by definition, constant across years (Figure \@ref(fig:hbll-spatial-re)), and the spatiotemporal random effects varied across years (Figure \@ref(fig:hbll-spatiotemporal-re)).

We then calculated expected biomass $B_t$ in year $t$ as:

$$
B_t = \sum_{j = 1}^{n_j}
  w_j \cdot \exp \left( \bm{X}_{j,t} \bm{\beta} + \omega_j + \epsilon_{j,t} \right),
$$

where $j$ references a grid cell within the survey domain and $w_j$ represents the area of that grid cell (Figure \@ref(fig:hbll-area-grid)).
In other words, we summed the predicted biomass across all grid cells within the survey domain for each year.
We generated standard errors on the annual estimates of log biomass via the generalized delta method as implemented in TMB [@tmb].

The resulting standardized population index accounts for the irregular sampling of the survey domain and hook competition and "stitches" the northern and southern regions into a single population index (Figure \@ref(fig:hbll-index)).
The inclusion of depth or the exclusion of the hook competition adjustments had relatively minor effects on the population index (Figure \@ref(fig:hbll-index)).
The model was also able to "fill in" what the index might hypothetically look like for the northern and southern regions independently (Figure \@ref(fig:hbll-index)).
Note that this statistical interpolation cannot account for one-off events in the unobserved region such as an abnormally high abundance only in the northern region in a year when the southern region was surveyed.
 
### Simulation testing survey "stitching" via spatiotemporal models {#sec:hbll-sim}

We undertook a basic simulation analysis to test that our approach of "stitching" northern and southern regions into a single survey domain was reasonable from a statistical perspective.
We generated a system that roughly matches the HBLL survey data we worked with in this document:

* 10 years of observations
* 100 possible spatial observation locations $x$ and $y$ drawn from a Uniform(0, 1) distribution each year.
* A marginal SD($\omega_s$) = 2.2
* A marginal SD($\epsilon_{s,t}$) = 0.3
* A \mbox{Mat\'ern} parameter $\kappa = 0.1$
* Annual means drawn from a Lognormal(0.1, 0.2) distribution
* A Poisson observation process for simplicity

We simulated the underlying true mean abundance on a complete [0, 1] grid with 25 x 25 grid cells.
We then discarded the northern and southern regions (above or below 0.5) in alternating years to render approximately 50 observations per year and attempted to fit the same form of spatiotemporal model as the one used for the HBLL index standardization (Figure \@ref(fig:stich-sim-pred)).

Despite the model only seeing alternating northern and southern regions, the model was able to reconstruct the unobserved missing portions based on the estimated spatial correlation, and to a lesser extent, the estimated spatiotemporal correlation (Figure \@ref(fig:stich-sim-pred)).
By projecting the model predictions onto a grid over the full area of the simulated square, our model was able to produce an index that was similar to the true index (Figure \@ref(fig:stich-sim-index)).
If we instead naively generated the index using an approach to mimic a design-based approach (by summing the observed abundances each year), the resulting index does not reflect the true index in many years (Figure \@ref(fig:stich-sim-index)).

Through experimentation (not shown) we found that the stitching was most accurate at recapturing the true index if the magnitude of spatial correlation deviations ($\omega_s$) was much larger than the magnitude of spatiotemporal correlation deviations ($\epsilon_{s,t}$).
This is the case in our HBLL model, where the marginal standard deviation of $\omega_s$ was approximately six times larger than the marginal standard deviation of $\epsilon_{s,t}$.

```{r}
include_figs <- function(file) {
  knitr::include_graphics(here::here("figs", file), dpi = NA)
}
```

```{r hbll-raw, fig.cap="Inside HBLL survey observations of Yelloweye Rockfish. Gray background shading indicates the northern and southern survey areas. The area of the circles represents the number of fish caught per hook after accounting for hook competition.", out.width="\\textwidth"}
include_figs("hbll-joint-raw-data.png")
```

```{r hbll-area-grid, out.width="5in", fig.cap="Area per survey grid cell that is in water for the inside HBLL survey. The predicted count density for each grid cell is scaled up to the full survey domain based on these areas."}
include_figs("hbll-area-in-water.png")
```

```{r hbll-baited, fig.cap="Proportion baited hooks returned for the inside HBLL survey. Note the substantial difference between the northern and southern areas and the change in the north between 2003--2007 in subsequent years.", out.width="\\textwidth"}
include_figs("hbll-joint-baited.png")
```

```{r hbll-hook-adjustment, fig.cap="Hook adjustment factor for the inside HBLL survey accounting for the number of hooks and the number of returned baited hooks.", out.width="\\textwidth"}
include_figs("hbll-joint-hook-adjust.png")
```

```{r hbll-spde, fig.cap="Stochastic Partial Differential Equation (SPDE) mesh for the HBLL. The open grey circles in the background (often hidden) represent the locations of the observed data and the red dots represent the \"knots\". The lines show the triangularization mesh used in the SPDE approximation and bilinear interpolation. A greater number of knots will increase the accuracy of the approximation at the expense of computational time.", out.width="0.6\\textwidth"}
include_figs("hbll-joint-spde.png")
```

```{r hbll-predicted-spacetime, fig.cap="Predicted relative density in space and time for the inside HBLL survey. Observed (hook-adjusted) counts are illustrated with circles. Predictions are illustrated with colour shading.", out.width="\\textwidth"}
include_figs("hbll-joint-prediction-log.png")
```

```{r hbll-spatial-re, fig.cap="The spatial random effects. These are consistent spatially correlated differences in expected abundance through time. The values are shown in link (log) space.", out.width="4.2in"}
include_figs("hbll-joint-omega.png")
```

```{r hbll-spatiotemporal-re, fig.cap="The spatiotemporal random effects. These are spatially correlated deviations that change through time. Note the reversion to the mean in area-year combinations without sampling data. Note the difference in magnitude between the spatial random effects (previous figure) and these spatiotemporal random effects.", out.width="\\textwidth"}
include_figs("hbll-joint-epsilon.png")
```

```{r hbll-index, out.width="4in", fig.cap="The joint relative abundance index. Top panel shows the joint prediction from the spatial temporal model. Included are three versions: (1) random effects and annual means only, (2) adding a depth covariate, and (3) removing the hook adjustment factor. The middle and bottom panels show the joint predictions for the northern and southern areas. All shaded regions represent 95\\% confidence intervals. The joint index timeseries in the top panel have been scaled to have the same geometric mean as the main ``HBLL INS'' index for visualization purposes. In the second and third rows, the solid dots represent years with observations and the open dots represent years without observations. Similarly, the dashed vertical lines indicate years with surveys (mostly) in the southern area."}
include_figs("hbll-index-components-eps-depth2.png")
```

\clearpage

```{r stich-sim-pred, fig.cap="Simulation testing the relative abundance index calculation with alternating north and south observations. (A) The true simulated (mean) abundance in space and time. (b) The observed (dots) and estimated (colour) counts in space and time from the geostatistical model. The observations occur in north and south regions in alternating years and are ``blind'' to the missing region. Notice how the spatial temporal model is able to predict what the abundance should be in the ``blind'' region based on the consistent spatial correlation pattern (and to a lesser degree the spatiotemporal correlation pattern).", out.width="\\textwidth"}
include_figs("geostatistical-sim-predicted.png")
```

\clearpage

```{r stich-sim-index, fig.cap="Simulation testing the relative abundance index calculation with alternating north and south observations. The solid red line represents the true simulated abundance through time. The dashed and dotted green line represents a ``naive'' design-based estimate, which is calculated here by calculating the abundance with just the observed north or south counts in each year. The dashed blue line represents a geostatistical standardized index that attempts to account for the north-south biennial observations. The shaded blue region represents the modelled 95\\% confidence interval.", out.width="5in"}
include_figs("geostatistical-sim-stitched-index.png")
```

\clearpage

## DOGFISH SURVEY INDEX {#sec:dogfish-index-data}

The Pacific Spiny Dogfish (*Squalus suckleyi*) survey samples nine locations in the Strait of Georgia that were historically fished by the commercial Dogfish fishery [@king2012].
The survey was first carried out in 1986, with subsequent sampling in 1989, 2005, 2011, 2014, and 2019.
The survey is a depth stratified longline survey that uses snap on gear with 300 circle hooks baited with Pacific Herring and a two hour soak time.
A more detailed description of survey methods is provided in [@king2012].
For most of the time series, set-by-set catch of Rockfish has been recorded.
Beginning in 2019, hook-by-hook data for all captured species was collected on board by DFO technicians, along with biological data for Rockfish.
We use a spatiotemporal model to estimate the density of Yelloweye Rockfish per km^2^. We calculate the area swept by multiplying the number of hooks deployed by the estimated width swept by the length of two gagnions and the estimated distance between hooks (8ft spacing).

### Hook comparison {#sec:dog-hook-comparison}

The survey fished with J-hooks originally and then changed to circle hooks in 2005.
In 2004, @mcfarlane2005 undertook a calibration study to assess the potential for a change in catch rates due to a switch from J-hooks to circle hooks.
The study only compared catch rates for Spiny Dogfish; however, the hook change likely affected catchability for Yelloweye Rockfish differently than for Spiny Dogfish.
In the previous assessment, a catchability ratio was estimated using data for all rockfish and this ratio was used to scale the values in the 1980s.
It is not clear from the previous assessment how this catchability ratio was estimated.
The previous assessment was quite sensitive to the resulting Dogfish index (because of the large decline from the 1980s), and that decline was largely dependent on the hook ratio.
In the current analysis, we standardize the population index using a spatiotemporal geostatistical model that accounts for spatial and spatiotemporal correlation in Yelloweye Rockfish abundance while simultaneously accounting for the number of dogfish caught (to partially correct for hook competition) and estimating a correction factor for the hook change.
By estimating the correction factor simultaneously with the standardization model, we are able to incorporate uncertainty in the correction factor into the resulting index standard errors.

### Depth {#sec:dog-depth}

In addition to the survey not being designed for rockfishes, and the change in gear type, the shallower depth stratum was dropped in 2004 and later surveys.
This was done to purposely try to avoid catching rockfish (because of conservation concerns).
While depth is not explicitly included in the spatiotemporal model, the spatial random effects should absorb much of the variation driven by depth will also accounting for other spatially varying effects.

### Hook competition {#sec:dog-hook-competition}

The previous inside Yelloweye Rockfish assessment notes using an exponential hook competition model on the dogfish survey data in 2011.
However, there are no data on the number of baited and empty hooks available for the dogfish survey prior to 2019 and it is unclear how the previous assessment accounted for this.
Therefore, we did not apply an explicit hook competition model in the present analysis.
However, to partially account for hook competition, we included the number of dogfish caught (log transformed so is to have a multiplicative effect on observed account) as a covariate in the model.

### Selectivity {#sec:dog-selectivity}

**The circle hooks used now are one size bigger than on HBLL and who knows what the selectivity was with the j-hooks! No rockfish biological data were formerly collected. So, in absence of info, I think we can use the same selectivity as long as we acknowledge the uncertainty (This is a note from one of Dana's emails but I'm not sure what was actually decided for selectivity-MJB)**

### Spatiotemporal dogfish survey index standardization

We used a similar geostatistical model to that described for the HBLL survey (Section \@ref(sec:hbll-spatiotemporal)) with the addition of Dogfish and hook-type covariates. We included the log Dogfish count and hook-type in the model matrix $\bm{X}_{s,t}$:

\begin{align}
  y_{s,t} &\sim \mathrm{NegBin}(\mu_{s,t}, \phi),\\
  \mu_{s,t} &= \exp \left( \bm{X}_{s,t} \bm{\beta} + \omega_s + \epsilon_{s,t} \right),
(\#eq:dogfish-model)
\end{align}

with symbols defined as above.
Hook-type is an identifier for J-hook vs. circle-hook.

In our projection of the model predictions onto the survey grid to calculate the standardized relative abundance:

$$
B_t = \sum_{j = 1}^{n_j}
  w_j \cdot \exp \left( \bm{X}_{j,t} \bm{\beta} + \omega_j + \epsilon_{j,t} \right),
$$

```{r dogfish-model}
m <- readRDS(here::here("data-generated/dogfish-model.rds"))
est <- as.list(m$sd_report, "Estimate")
se <- as.list(m$sd_report, "Std. Error")
```

with symbols defined as above, we could predict for a J-hook or a circle hook.
Choosing one or the other would place more of the uncertainty in the years with one or the other since the offsetting effect's uncertainty would be incorporated in only some years.
As a compromise, we chose to predict for an average hook type across the data set to distribute this hook-type uncertainty across the timeseries.
In practice, this meant coding circle hooks as `r round(min(m$data$circle_hook_centered), 2)` and J-hooks as `r round(max(m$data$circle_hook_centered), 2)` in the model-fitting matrix $\bm{X}_{s,t}$ and setting the equivalent predictor in the prediction model matrix to 0.

We estimated that J-hooks caught
`r sprintf("%.1f", round(exp(est$b_j[1]), 1))` times more Yelloweye Rockfish than circle-hooks, all else being equal, but with considerable uncertainty (95% confidence interval (CI): `r sprintf("%.1f", round(exp(est$b_j[1] - 1.96 * se$b_j[1]), 1))` -- `r sprintf("%.1f", round(exp(est$b_j[1] + 1.96 * se$b_j[1]), 1))`).
We estimated the log Dogfish effect to be `r sprintf("%.2f", round((est$b_j[10]), 2))` (95% CI: `r sprintf("%.2f", round((est$b_j[10] - 1.96 * se$b_j[10]), 2))` -- `r sprintf("%.2f", round((est$b_j[10] + 1.96 * se$b_j[10]), 2))`).
This means that we can expect to catch, on average, about `r sprintf("%.2f", -1*round((est$b_j[10]), 2))`% (95% CI: `r sprintf("%.2f", -1*round((est$b_j[10] - 1.96 * se$b_j[10]), 2))` -- `r sprintf("%.2f", -1*round((est$b_j[10] + 1.96 * se$b_j[10]), 2))`%)
fewer Yelloweye Rockfish for every 1% also caught on the same skate, presumably due to hook competition.


<!--
**Sean's notes**
Notes:

I'm estimating the index for an "average" hook type. If we estimate for one or the other type then it puts more or less uncertainty into the first or second half of the time series (the estimates themselves are just scaled though).

It is now able to estimate spatiotemporal random effects and with the help of the spatial correlation it seems to be better able to estimate the hook type correction with appropriate uncertainty. You can see the estimated correction factor in the model output:

exp(2.04)
[1] 7.690609

exp(2.04 + c(-2, 2) * 0.80)
[1]  1.552707 38.091837

I'm sure thats an exaggeration, but so it is with few data points and no priors. At least by including it in one model we can let the data speak for themselves.

I am creating the index on the rectangles that define the dogfish survey. I overlaid a 500m x 500m grid on the dogfish survey rectangles and am now also removing any of those fine scale grid cells that overlap land.
-->

\clearpage

```{r, fig.cap="Raw data", out.width="\\textwidth"}
include_figs("dogfish-yelloweye-per-area-data.png")
```

```{r, fig.cap="Prediction with log transformed color scale.", out.width="\\textwidth"}
include_figs("dogfish-prediction-log.png")
```

```{r, fig.cap="Spatial random effects.", out.width="4.2in"}
include_figs("dogfish-omega.png")
```

```{r, fig.cap="Spatiotemporal random effects.", out.width="\\textwidth"}
include_figs("dogfish-epsilon.png")
```

```{r, fig.cap="Standardized index.", out.width="5in"}
include_figs("dogfish-index-estimated-hook.png")
```

\clearpage
